<!DOCTYPE html>
<html>

<head>
	<title>WFO Map</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
		integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
		integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<style>
		#map {
			height: 100%;
		}

		html,
		body {
			height: 100%;
			margin: 0;
			padding: 0;
		}
	</style>
</head>

<body>
	<div id="map"></div>
	<script>

		async function get_map(id) {
			try {
				const response = await axios.get('api/map/' + id);
				return response.data.data;
			} catch (error) {
				console.error("Error getting maps:", error);
				return null;
			}
		}


		async function get_map_seats(map_id) {
			try {
				const response = await axios.get(`api/map/${map_id}/seats`);
				return response.data.data;
			} catch (error) {
				console.error(`Error getting seats for map ${map_id}:`, error);
				return null;
			}
		}

		async function initMap() {
			const map = L.map('map', {
				crs: L.CRS.Simple
			});

			const mapData = await get_map(new URLSearchParams(window.location.search).get('id'));

			const imageBounds = [[0, 0], [mapData.imageBoundsY, mapData.imageBoundsX]]; // [[y1, x1], [y2, x2]]
			L.imageOverlay(mapData.map, imageBounds).addTo(map);

			map.fitBounds(imageBounds);

			const seatsData = await get_map_seats(new URLSearchParams(window.location.search).get('id'));

			const selectedSeat = new URLSearchParams(window.location.search).get('seat_id');

			for (const seat of seatsData) {
				let mark = true;
				if (selectedSeat) {
					mark = false;
				}
				const seatCenter = [seat.y_coordinate, seat.x_coordinate]; // [y, x]
				let seatColor = seat.bookable ? "green" : "red";
				if (selectedSeat && seat.id == selectedSeat) {
					seatColor = "purple";
					mark = true;
				}
				if (!mark) {
					continue;
				}
				L.circle(seatCenter, { radius: 5, color: seatColor, weight: 1, fillOpacity: 0.5 })
					.bindPopup(`<b>${seat.name}</b><br>${seat.description}`)
					.addTo(map);
				if (selectedSeat && seat.id == selectedSeat) {
					map.setView(seatCenter, 2);
				}
			}
		}

		initMap();
	</script>
</body>

</html>