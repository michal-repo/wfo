<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>WFO Calendar</title>
	<link rel="icon" href="favicon.ico" type="image/x-icon">
	<script src='https://cdn.jsdelivr.net/npm/fullcalendar/index.global.min.js'></script>
	<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
		crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
	<script src="scripts.js"></script>
	<link href='style.css' rel='stylesheet'>
	<script defer>
		function logError(message, error) {
			console.error(message, error);
			alert(message);
		}
		let calendar;

		document.addEventListener('DOMContentLoaded', function () {
			const calendarEl = document.getElementById('calendar');
			login_check().then(async (r) => {
				let headerToolbarCustomButtons = "";
				let settings = null;
				if (r) {
					settings = await get_settings();
					headerToolbarCustomButtons += " Menu";
					headerToolbarCustomButtons += " Map";
					headerToolbarCustomButtons += " LogOut";
				} else {
					headerToolbarCustomButtons += " LogIn";
				}
				calendar = new FullCalendar.Calendar(calendarEl, {
					timeZone: 'UTC',
					locale: settings ? (settings.language ? settings.language : 'en') : 'en',
					themeSystem: 'bootstrap5',
					initialView: 'dayGridMonth',
					weekNumberCalculation: "ISO",
					hiddenDays: generate_hidden_days(settings ? settings.days : null),
					height: get_cal_height(),
					windowResize: function (arg) {
						calendar.setOption('height', get_cal_height());
					},
					eventClick: function (info) {
						switch_day(info.event.start.toISOString(), info.event.title)
					},
					eventOrder: "id,start,-duration,allDay,title",
					customButtons: {
						Menu: {
							text: 'Menu',
							click: function () {
								new bootstrap.Offcanvas(document.getElementById("sidebarMenu")).toggle();
							},
							hint: "Show menu"
						},
						Map: {
							text: 'Map',
							click: function () {
								show_map_today();
							},
							hint: "Show menu"
						},
						LogOut: {
							text: 'Log out',
							click: function () {
								log_out();
							},
							hint: "Log out"
						},
						LogIn: {
							text: 'Log in/Register',
							click: function () {
								window.location.replace("/wfo");
							},
							hint: "Log in or Register"
						}
					},
					headerToolbar: {
						left: 'dayGridMonth,timeGridWeek' + headerToolbarCustomButtons,
						center: 'title',
						right: 'prev,next today'
					},
					events: 'api/feed'
				})
				calendar.render();

				let target = document.getElementById('calendar');
				let observer = new MutationObserver(function (mutations) {
					update_stats(calendar.getDate().getFullYear(), calendar.getDate().getMonth() + 1);
				});
				let config = { attributes: true, childList: true, characterData: true, subtree: true };
				observer.observe(target, config);


			});

		})

		function switch_day(day, event_text) {
			if (event_text.includes("Add Bank holiday")) {
				axios.post(`api/bank-holiday/add`, {
					day: day
				}).then(response => {
					calendar.refetchEvents();
				}).catch(error => {
					logError('There was an error switching the day:', error);
				});
			} else if (event_text.includes("Add holiday")) {
				axios.post(`api/holiday/add`, {
					day: day
				}).then(response => {
					calendar.refetchEvents();
				}).catch(error => {
					logError('There was an error switching the day:', error);
				});
			} else if (event_text.includes("Add Sick Leave")) {
				axios.post(`api/sickleave/add`, {
					day: day
				}).then(response => {
					calendar.refetchEvents();
				}).catch(error => {
					logError('There was an error switching the day:', error);
				});
			} else if (event_text.includes("Book Seat") || event_text.includes("Booked seat")) {
				populate_maps_list_in_seat_selection();
				populate_recent_seat_choices();
				Modal = new bootstrap.Modal(document.getElementById('seatSelection'));
				document.getElementById('seatSelectionDay').value = day;
				Modal.toggle();
			} else if (event_text.includes("Add Overtime")) {
				const hours = prompt("How many hours of overtime?");
				if (hours != null) {
					axios.post(`api/overtime/add`, {
						date: day,
						hours: hours
					}).then(response => {
						calendar.refetchEvents();
					}).catch(error => {
						logError('There was an error switching the day:', error);
					});
				}
			} else if (event_text.includes("h Overtime")) {
				const hours = confirm("Remove overtime?");
				if (hours != null && hours == true) {
					axios.post(`api/overtime/delete`, {
						date: day
					}).then(response => {
						calendar.refetchEvents();
					}).catch(error => {
						logError('There was an error deleting overtime on the day:', error);
					});
				}
			} else {
				axios.post(`api/switch`, {
					day: day
				}).then(response => {
					calendar.refetchEvents();
				}).catch(error => {
					logError('There was an error switching the day:', error);
				});
			}
		}

		function log_out() {
			axios.post(`api/log-out`).then(response => {
				window.location.replace("/wfo");
			}).catch(error => {
				logError('There was an error: ', error);
			});
		}

		function get_cal_height() {
			return document.getElementById("wfo-calendar").offsetHeight;
		}

	</script>
</head>

<body>
	<span id="today-seat"></span>
	<div class="offcanvas offcanvas-start navigation-menu" tabindex="-1" id="sidebarMenu"
		aria-labelledby="sidebarMenuLabel">
		<div class="offcanvas-header">
			<h5 class="offcanvas-title" id="sidebarMenuLabel">Menu</h5>
			<button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
		</div>
		<div class="offcanvas-body">
			<ul class="nav flex-column">
				<li class="navigation-menu-item odd">
					<a href="#submenu" data-bs-toggle="collapse" class="nav-link">
						Calendar settings</a>
					<ul class="collapse nav flex-column ms-4" id="submenu" data-bs-parent="#sidebarMenu">
						<li>
							<a type="button" class="nav-link" data-bs-toggle="modal" data-bs-target="#monthTargetModal"
								href="#">
								Edit month target
							</a>
						</li>
						<li>
							<a type="button" class="nav-link" data-bs-toggle="modal" data-bs-target="#workingDaysModal"
								href="#">
								Edit working days
							</a>
						</li>
						<li>
							<a type="button" class="nav-link" data-bs-toggle="modal" data-bs-target="#yearTargetModal"
								href="#">
								Edit year target
						</li>
						</a>
					</ul>
				</li>

				<li class="nav-item navigation-menu-item even">
					<a type="button" class="nav-link" data-bs-toggle="modal" data-bs-target="#tokensCommands" href="#"
						onclick="(function(){
									get_tokens();
									return true;
								})();return true;">
						Manage access tokens
					</a>
				</li>
				<li class="nav-item navigation-menu-item odd">
					<a type="button" class="nav-link" data-bs-toggle="modal" data-bs-target="#statistics" href="#"
						onclick="(function(){
				populate_stats_in_modal();
				return true;
			})();return true;">
						Statistics
					</a>
				</li>
				<li class="nav-item navigation-menu-item odd">
					<a type="button" class="nav-link" data-bs-toggle="modal" data-bs-target="#maps" href="#" onclick="(function(){
				populate_maps_list();
				return true;
			})();return true;">
						Maps
					</a>
				</li>
				<li class="nav-item navigation-menu-item even">
					<a type="button" class="nav-link" data-bs-toggle="modal" data-bs-target="#settings" href="#"
						onclick="(function(){
				populate_settings_in_modal();
				return true;
			})();return true;">
						<i class="bi bi-gear"></i>&nbsp;Settings
					</a>
				</li>
			</ul>
		</div>
	</div>
	<div id="stats" class="stats container-fluid">
		<div class="row">
			<div class="col-10">
				<span class="stat">Month Target - <b><span id="month-target"></span>%</b></span>
				&nbsp;&nbsp;
				<span class="stat">Working Days - <b id="working-days"></b></span>
				&nbsp;&nbsp;
				<span class="stat">Office days (actual/min.) - <b id="office-actual-min"></b></span>
				&nbsp;&nbsp;
				<span class="stat">Holidays - <b id="holidays"></b></span>
				&nbsp;&nbsp;
				<span class="stat">Sick leave - <b id="sickleave"></b></span>
				&nbsp;&nbsp;
				<span class="stat">Overtime - <b id="overtime"></b></span>
			</div>
			<div class="col-2">
				<span class="stat">Year Target - <b><span id="year-target"></span>%</b></span>
			</div>
		</div>
		<div class="row mt-2">
			<div class="col-10">
				<div class="progress">
					<div class="progress-bar" id="month-target-progressbar" role="progressbar"></div>
				</div>
			</div>
			<div class="col-2">
				<div class="progress">
					<div class="progress-bar" id="year-target-progressbar" role="progressbar"></div>
				</div>
			</div>
		</div>
	</div>



	<div id="wfo-calendar" class="wfo-calendar">
		<div id='calendar'></div>
	</div>


	<div class="modal fade" id="monthTargetModal" tabindex="-1" aria-labelledby="monthTargetModalLabel"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="monthTargetModalLabel">Modify month target</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<label for="month-target-edit" class="form-label">Month Target</label>
						<input type="text" class="form-control" id="month-target-edit">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="(function(){
                        set_month_target(calendar.getDate().getFullYear(), 
                            calendar.getDate().getMonth() + 1, 
                            document.getElementById('month-target-edit').value
                        );
                        setTimeout(() => {
                            update_stats(calendar.getDate().getFullYear(), calendar.getDate().getMonth() + 1);
                        }, 500);
                        return true;
                    })();return true;">Save changes</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="workingDaysModal" tabindex="-1" aria-labelledby="workingDaysModalLabel"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="workingDaysModalLabel">Modify working days</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<label for="working-days-edit" class="form-label">workingDays</label>
						<input type="text" class="form-control" id="working-days-edit">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="(function(){
                        set_working_days(calendar.getDate().getFullYear(), 
                            calendar.getDate().getMonth() + 1, 
                            document.getElementById('working-days-edit').value
                        );
                        setTimeout(() => {
                            update_stats(calendar.getDate().getFullYear(), calendar.getDate().getMonth() + 1);
                        }, 500);
                        return true;
                    })();return true;">Save changes</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="yearTargetModal" tabindex="-1" aria-labelledby="yearTargetModalLabel"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="yearTargetModalLabel">Modify year target</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<label for="year-target-edit" class="form-label">yearTarget</label>
						<input type="text" class="form-control" id="year-target-edit">
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="(function(){
                        set_year_target(calendar.getDate().getFullYear(), 
                            document.getElementById('year-target-edit').value
                        );
                        setTimeout(() => {
                            update_stats(calendar.getDate().getFullYear(), calendar.getDate().getMonth() + 1);
                        }, 500);
                        return true;
                    })();return true;">Save changes</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade modal-xl" id="generatedCommands" tabindex="-1" aria-labelledby="generatedCommandsLabel"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="generatedCommandsLabel">Generated commands</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<code id="generatedCommandsBody"></code>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>


	<div class="modal fade modal-xl" id="tokensCommands" tabindex="-1" aria-labelledby="tokensCommandsLabel"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="tokensCommandsLabel">Tokens</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<label for="token-name" class="form-label">Token Name</label>
						<input type="text" class="form-control" id="token-name"
							placeholder="Enter a name for the token">
					</div>
					<div class="mb-3">
						<button type="button" class="btn btn-primary"
							onclick="newToken('token-display', 'token-name')">Generate new token</button>
						<div class="mt-3">
							<label for="token-display" class="form-label">Generated Token:</label>
							<input type="text" readonly class="form-control" id="token-display"
								placeholder="Your new token will appear here...">
						</div>
					</div>
					<hr>
					<div class="mb-3">
						<h5>Existing Tokens:</h5>
						<div id="existing-tokens-list"></div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>


	<div class="modal fade modal-xl" id="settings" tabindex="-1" aria-labelledby="settingsLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="settingsLabel">Settings</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<label class="form-label">Days to show:</label>
						<div id="settings-days-to-show" class="d-flex flex-wrap">
							<div class="form-check me-3">
								<input class="form-check-input" type="checkbox" value="mon" id="show-mon" checked>
								<label class="form-check-label" for="show-mon">Monday</label>
							</div>
							<div class="form-check me-3">
								<input class="form-check-input" type="checkbox" value="tue" id="show-tue" checked>
								<label class="form-check-label" for="show-tue">Tuesday</label>
							</div>
							<div class="form-check me-3">
								<input class="form-check-input" type="checkbox" value="wed" id="show-wed" checked>
								<label class="form-check-label" for="show-wed">Wednesday</label>
							</div>
							<div class="form-check me-3">
								<input class="form-check-input" type="checkbox" value="thu" id="show-thu" checked>
								<label class="form-check-label" for="show-thu">Thursday</label>
							</div>
							<div class="form-check me-3">
								<input class="form-check-input" type="checkbox" value="fri" id="show-fri" checked>
								<label class="form-check-label" for="show-fri">Friday</label>
							</div>
							<div class="form-check me-3">
								<input class="form-check-input" type="checkbox" value="sat" id="show-sat" checked>
								<label class="form-check-label" for="show-sat">Saturday</label>
							</div>
							<div class="form-check me-3">
								<input class="form-check-input" type="checkbox" value="sun" id="show-sun" checked>
								<label class="form-check-label" for="show-sun">Sunday</label>
							</div>
						</div>
						<hr>
						<label class="form-label">Language:</label>
						<select id="settings-language" class="form-select w-auto">
							<option value="en">English</option>
							<option value="pl">Polish</option>
							<option value="fr">French</option>
							<option value="de">German</option>
							<option value="es">Spanish</option>
							<option value="it">Italian</option>
							<option value="nl">Dutch</option>
							<option value="pt">Portuguese</option>
							<option value="sv">Swedish</option>
							<option value="da">Danish</option>
							<option value="fi">Finnish</option>
						</select>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="(function(){
						save_settings();
						return true;
					})();return true;">Save changes</button>
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>


	<div class="modal fade modal-xl" id="statistics" tabindex="-1" aria-labelledby="statisticsLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="statisticsLabel">Statistics for <span id="stats-title"></span></h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">

					<p class="stat">Month Target - <b><span id="stats-month-target"></span>%</b></p>

					<p class="stat">Working Days - <b id="stats-working-days"></b></p>

					<p class="stat">Office days (actual/min.) - <b id="stats-office-actual-min"></b></p>

					<p class="stat">Holidays - <b id="stats-holidays"></b></p>

					<p class="stat">Sick leave - <b id="stats-sickleave"></b></p>

					<p class="stat">Overtime - <b id="stats-overtime"></b></p>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade modal-xl" id="maps" tabindex="-1" aria-labelledby="mapsLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="mapsLabel">Maps</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<input type="file" class="form-control" id="map-file" required accept=".png">
					<input type="text" class="form-control mt-2" id="map-name" required placeholder="Enter map name">
					<input type="text" class="form-control mt-2" id="map-imageBoundsX" required
						placeholder="Enter image bounds X">
					<input type="text" class="form-control mt-2" id="map-imageBoundsY" required
						placeholder="Enter image bounds Y">
					<button type="button" class="btn btn-primary mt-2" onclick="upload_map()">Upload Map</button>
					<hr>
					<div id="maps-list" class="mt-3"></div>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade modal-xl" id="seatSelection" tabindex="-1" aria-labelledby="seatSelectionLabel"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="seatSelectionLabel">Seat Selection</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<input type="text" class="form-control mt-2" id="seatSelectionSeatName" required placeholder="Enter seat name">
					<div id="recent-choices"></div>
					<select class="form-select mt-2" id="seatSelectionMapSelect" required>
						<option value="" disabled selected>Select map</option>
					</select>
					<input type="hidden" class="form-control mt-2" id="seatSelectionDay">
					<button type="button" class="btn btn-primary mt-2" onclick="book_seat()">Book Seat</button>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				</div>
			</div>
		</div>
	</div>



</body>

</html>
